<!DOCTYPE html>
<html lang="{{ site.lang | default: 'ru' }}">
<head>
    {% include head.html %}
</head>
<body>
    <!-- Global Site Particles -->
    <div class="site-particles">
        <div class="site-particle" style="--x: 5%; --y: 10%; --delay: 0s;"></div>
        <div class="site-particle" style="--x: 95%; --y: 15%; --delay: 2s;"></div>
        <div class="site-particle" style="--x: 15%; --y: 25%; --delay: 4s;"></div>
        <div class="site-particle" style="--x: 85%; --y: 35%; --delay: 6s;"></div>
        <div class="site-particle" style="--x: 25%; --y: 45%; --delay: 8s;"></div>
        <div class="site-particle" style="--x: 75%; --y: 55%; --delay: 10s;"></div>
        <div class="site-particle" style="--x: 35%; --y: 65%; --delay: 12s;"></div>
        <div class="site-particle" style="--x: 65%; --y: 75%; --delay: 14s;"></div>
        <div class="site-particle" style="--x: 45%; --y: 85%; --delay: 16s;"></div>
        <div class="site-particle" style="--x: 55%; --y: 95%; --delay: 18s;"></div>
    </div>

    {% include header.html %}

    <main id="main-content" role="main">
        {{ content }}
    </main>

    {% include footer.html %}
    {% include modals.html %}

    <!-- Основной скрипт загружается сразу -->
    <script src="{{ '/js/script.js' | relative_url }}"></script>
    
    <!-- Остальные скрипты загружаются асинхронно -->
    <script>
        // Lazy load scripts
        function loadScript(src, callback) {
            const script = document.createElement('script');
            script.src = src;
            script.async = true;
            script.onload = callback;
            document.head.appendChild(script);
        }

        // Load scripts after page load
        window.addEventListener('load', function() {
            // Chart.js только для страниц с графиками
            if (document.querySelector('canvas')) {
                loadScript('https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js');
            }
            
            // Crypto data
            loadScript('{{ "/js/crypto-data.js" | relative_url }}');
            
            // Analytics только на странице аналитики
            if (window.location.pathname.includes('/analytics/')) {
                loadScript('{{ "/js/analytics-data.js" | relative_url }}', function() {
                    loadScript('{{ "/js/analytics-chart.js" | relative_url }}');
                });
            }
            
            // Trading card updater
            if (document.querySelector('.trading-card')) {
                loadScript('{{ "/js/trading-card-updater.js" | relative_url }}');
            }
        });
    </script>

    <!-- Service Worker для PWA -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('{{ "/sw.js" | relative_url }}')
                    .then(registration => {
                        console.log('SW registered: ', registration);
                    })
                    .catch(registrationError => {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }
    </script>

    <!-- Аналитика (если настроена) -->
    {% if site.analytics.google_id %}
    <script async src="https://www.googletagmanager.com/gtag/js?id={{ site.analytics.google_id }}"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', '{{ site.analytics.google_id }}');
    </script>
    {% endif %}
</body>
</html>
